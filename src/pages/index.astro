---

import BaseLayout from '../layout/BaseLayout.astro'

import VideoModal from '../components/Videomodal.jsx'
import Videobox from '../components/Videobox.astro'

const serverUrl = import.meta.env.NEXT_PUBLIC_SERVER_URL;

const [videoResponse, musicResponse] = await Promise.all([
  fetch(`${serverUrl}api/videos?limit=1000&sort=priority`),
  fetch(`${serverUrl}api/music?limit=1000&sort=priority`)
]);

let videosIdAndDescription = [] as any[]

if (videoResponse.ok) {
  const data = await videoResponse.json();
  const videos = data.docs as any[];

  const youtubeUrlRegexp = /(?:watch\?v=|youtu\.be\/|\/(?:embed|shorts|live)\/)([a-zA-Z0-9_-]{11})/
  videosIdAndDescription = videos
    .map(({ videoUrl, description, priority }) => {
        const result = videoUrl.match(youtubeUrlRegexp)
        return result ? { videoId: result[1], description, priority: parseInt(priority) } : null
      })
    .filter(_ => _ != null);
} else {
  console.error("Failed to fetch videos from API:", videoResponse.status,
      videoResponse.statusText);
}

let musicIdAndDescription = [] as any[]

if (musicResponse.ok) {
  const data = await musicResponse.json();
  const videos = data.docs as any[];

  const youtubeUrlRegexp = /(?:watch\?v=|youtu\.be\/|\/(?:embed|shorts|live)\/)([a-zA-Z0-9_-]{11})/
  musicIdAndDescription = videos
    .map(({ videoUrl, description, priority }) => {
        const result = videoUrl.match(youtubeUrlRegexp)
        return result ? { videoId: result[1], description, priority: parseInt(priority) } : null
      })
    .filter(_ => _ != null);
} else {
  console.error("Failed to fetch videos from API:", musicResponse.status,
      musicResponse.statusText);
}

const allIdAndDescription = musicIdAndDescription
    .concat(videosIdAndDescription)
    .sort((a, b) => a.priority - b.priority)

---

<BaseLayout title="David J. Barrios">
  <!-- <h2 class="font-display font-light tracking-[0.15em] mb-23">Seleccionar proyecto</h2> -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-3 gap-y-15" id="video-gallery">
    {allIdAndDescription.map(({ videoId, description }) => (
      <Videobox
        id={videoId}
        thumbnailUrl={`https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`}
        description={description}
      />
    ))}
  </div>

  <VideoModal client:load listenOnId="video-gallery"/>
</BaseLayout>
