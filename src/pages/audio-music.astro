---

import BaseLayout from '../layout/BaseLayout.astro'

import Videobox from '../components/Videobox.astro'

const serverUrl = import.meta.env.NEXT_PUBLIC_SERVER_URL;

const response = await fetch(`${serverUrl}api/music?limit=1000&sort=priority`);

interface VideoInput {
  videoUrl: string;
  description: string;
  thumbnailUrl: string;
  priority?: number;
}

interface VideoOutput {
  videoId: string;
  description: string;
  thumbnailUrl: string;
  provider: 'youtube' | 'vimeo';
}

let videosIdAndDescription = [] as VideoOutput[]

if (response.ok) {
  const data = await response.json();
  const videos = data.docs as VideoInput[];

  const youtubeUrlRegexp = /(?:watch\?v=|youtu\.be\/|\/(?:embed|shorts|live)\/)([a-zA-Z0-9_-]{11})/
  const vimeoUrlRegexp = /(?:vimeo\.com\/|player\.vimeo\.com\/video\/)([0-9]+)/;
  videosIdAndDescription = videos
    .map(({ videoUrl, description, thumbnailUrl }) => {
        const ytMatch = videoUrl.match(youtubeUrlRegexp)
        if (ytMatch) {
          return {
            videoId: ytMatch[1],
            description,
            thumbnailUrl,
            provider: 'youtube'
          } as VideoOutput
        }
        const vimeoMatch = videoUrl.match(vimeoUrlRegexp)
        if (vimeoMatch) {
          return {
            videoId: vimeoMatch[1],
            description,
            thumbnailUrl,
            provider: 'vimeo'
          } as VideoOutput
        }
        return null
      })
    .filter(_ => _ != null);
} else {
  console.error("Failed to fetch videos from API:", response.status,
      response.statusText);
}

---

<BaseLayout title="Audio/Music â€” David J. Barrios">
  <!-- <h2 class="font-display font-light tracking-[0.15em] mb-23">Seleccionar proyecto</h2> -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-3 gap-y-15" id="video-gallery">
    {videosIdAndDescription.map(({ videoId, description, thumbnailUrl, provider }) => (
      <Videobox
        id={videoId}
        thumbnailUrl={thumbnailUrl === '' ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : thumbnailUrl}
        description={description}
        fallbackThumbnailUrl={`https://img.youtube.com/vi/${videoId}/hqdefault.jpg`}
        provider={provider}
      />
    ))}
  </div>
</BaseLayout>
